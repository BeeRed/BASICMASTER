# BASICMASTER TAPE FORMAT

## 物理フォーマット

- カンサスシティスタンダード形式（300bps）
	- https://en.wikipedia.org/wiki/Kansas\_City\_standard
- BASICMASTER Jr で1200bps ROMが追加された
- 有志による1200bpsルーチンが複数存在する。Jr版との互換性はない（と思う）
- 1200bpsは、いわゆる一波カンサス形式

## 論理フォーマット

### 300bps

|用途				|バイト数|詳細|
|-------------------|-------|-------------------------------------------|
|プリアンブル		|65		|$FF の連続|
|開始マーク			|1		|$01|
|種別				|1		|$00:最終ブロック、$01:バイナリ $10:テキスト|
|ブロック番号A		|1		|BASICのブロック番号|
|ファイル名			|6		|6文字に満たない場合は、後ろに空白を詰める|
|フォーマット		|1		|'B' または 'S'|
|ブロック番号B		|1		|複数ブロックが連続するときの番号|
|ブロックサイズ		|1		|1-256. $00のときは256と見なす|
|アドレス			|2		|上位・下位の順|
|ヘッダチェックサム	|1		|開始マーク〜アドレスまでの2の補数の和|
|データ				|1-256	|ブロックサイズ分のデータ|
|データチェックサム	|1		|データの2の補数の和|
|終了マーク			|2		|?|

BASICソースの場合は、256バイト以下のブロックが複数並ぶ形式。ブロックの数だけBYTOUTが呼ばれる。

(私が移植したNakamozu Tiny BASIC、GAME68/BMでも同様)

行番号が存在する言語や中間言語を持つインタプリタでは、メモリ上は行番号をバイナリで持っているためそのまま保存すると可読性に欠ける。一度LISTとして出力しながらバッファリングして保存すると、この形式になる。

```
> LOAD GALAXY

GALAXY.S   01					; ブロック番号B
GALAXY.S      -     1			; ブロック番号A、終了ブロック
GALAXY.S   01					; ブロック番号B
GALAXY.S      -     2			; ブロック番号A、終了ブロック
```

モニタでSAVEしたバイナリの場合は、大きなブロックが256バイト以下に分割されて連なる形式。

BYTOUTは1回だけ呼ばれる。

```
> LOAD DENDAI

DENDAI.B   01					; ブロック番号B
DENDAI.B   02
(中略)
DENDAI.B   09
DENDAI.B						; 終了ブロック
```

日立エディタ・アセンブラでSAVEしたソースも、大きなブロックが256バイト以下に分割されて連なる形式。
BYTOUTは1回だけ呼ばれる。

（私が移植したKUMAJIRIのRANPAKUエディタも同様）

メモリ上のソースコードとテープ上の並びが一致している場合は、こちらが楽。

```
 PROGRAM NAME : KUMA

KUMA  .S   01
KUMA  .S   02
(中略)
KUMA  .S   14
KUMA  .S
```

### 1200bps Jr

- プリアンブル			255		$55
- 開始マーク			1		$aa
- データ部先頭アドレス	2		上位・下位の順
- データ部終了アドレス	2		上位・下位の順
- 変数部先頭アドレス	2		上位・下位の順
- 変数部終了アドレス	2		上位・下位の順
- ファイル名			6		6文字に満たない場合は、後ろに空白を詰める
- フォーマット			1		'B' または 'S'
- 変数部				n
- データ部				n
- 終了マーク			1		$f0

### 1200bps BMUG

- $003B-$004Cをベタ書き	18
- ($3B,$3C)-($3D,$3F)	n

## BASICのSAVE

BASICのLIST出力をSAVEする。1行が複数ブロックにまたがることはない。行末はCR($0D)。
一度のBYTINで全部を転送することができないため、複数回BYTINが呼ばれる。
(ブロック番号が01のままなのは、このため）
最終ブロックは $FF $FF の2バイト
$0600-$06FFが転送用バッファとして使われる。
($0600,1が$FFFFであることを確認してフックする方法がBMUG 1200bps I/Oで使われている）

後知恵だが、SAVE時は行番号の前の空白を詰めたりLETを省略すれば、少しはLOAD/SAVEが速くなったろうに。

## I/Oルーチン

共通ワークエリア

- LDTOP/RECTOP			2		$003B,$3Cの2バイト。読み書きするデータの先頭アドレス
- LDMAX/RECEND			2		$003D,$3Eの2バイト。読み書きするデータの最終アドレス
- FNAME					8		$0043-$004A ファイル名。最後は'.B','.S'
- FNAME2				8		$004D-$0054 ファイル名2。ベリファイ用
- BYTIN					$002E	データ入力サブルーチン（$F018へ飛ぶ）
- BYTOUT				$0031	データ出力サブルーチン（$F81Bへ飛ぶ）
- LOAD					$F018
- SAVE					$F01B
- ファイル名入力		$F682	L2/L2II/Jr共通


## Example

TinyGalaxyのBASICソースプログラム。300bps

```
(前略）
00000030  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|	プリアンブル ff
00000040  ff 01 10 01 47 41 4c 41  58 59 2e 53 01 ea 06 00  |....GALAXY.S....|
             ^  ^  ^  <----- ファイル名 -----> ^  ^  ^^^^^
             |  |  |                           |  |  |
             |  |  |                           |  |  0600:アドレス
             |  |  01:ブロック番号A            |  ea:ブロックサイズ
             |  10:テキスト                    01:ブロック番号B
             01:開始マーク
00000050  b7 31 30 20 4d 55 53 49  43 20 54 32 50 36 ef bd  |.10 MUSIC T2P6..|
          ^  <------ BASICソース ------------------------>
          |
          b7:ヘッダチェックサム
(中略)
00000130  22 53 43 4f 52 45 3a 22  3b 53 0d 91 ff ff ff ff  |"SCORE:";S......|
          <---------- BASICソース---------> ^  ^^^^^^^^^^^
                                            |  プリアンブル
                                            91:データチェックサム
(中略)
00000170  ff ff ff ff ff ff ff ff  ff ff ff ff ff 01 00 01  |................|
          <--------- プリアンブル --------------> ^  ^  ^
                                                  |  |  |
                                                  |  |  01:ブロック番号A
                                                  |  00:終了ブロック
                                                  01:開始マーク
00000180  47 41 4c 41 58 59 2e 53  01 01 06 00 b0 31 cf ff  |GALAXY.S.....1..|
          <---- ファイル名 ----->  ^  ^  ^^^^^ ^  ^  ^  <-
                                   |  |  |     |  |  |
                                   |  |  |     |  |  cf:データチェックサム($100-$31)
                                   |  |  |     |  31:データ
                                   |  |  |     b0:ヘッダチェックサム
                                   |  |  0600:アドレス
                                   |  01:ブロックサイズ
                                   01:ブロック番号B
00000190  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|
(中略)
00000800  ff ff ff ff 01 10 06 47  41 4c 41 58 59 2e 53 01  |.......GALAXY.S.|
                      ^  ^  ^  <----- ファイル名 -----> ^
                      |  |  |                           |
                      |  |  |                           01:ブロック番号B
                      |  |  06:ブロック番号A                           
                      |  10:テキスト
                      01:開始マーク
00000810  3f 06 00 5d 32 37 30 20  49 46 20 52 4e 44 28 31  |?..]270 IF RND(1|
          ^  ^^^^^ ^  <---------- BASICソース ----------->
          |  |     |
          |  |     5d:ヘッダチェックサム
          |  0600:アドレス
          3f:ブロックサイズ
(中略)
00000890  ff ff ff ff ff 01 00 06  47 41 4c 41 58 59 2e 53  |........GALAXY.S|
                         ^  ^  ^   <---- ファイル名 ----->
                         |  |  |
                         |  |  06:ブロック番号A
                         |  00:最終ブロック
                         01:開始マーク
000008a0  01 01 06 00 ab 32 ce ff  ff ff ff ff ff ff ff ff  |.....2..........|
          ^  ^  ^^^^^ ^  ^  ^
          |  |  |     |  |  |
          |  |  |     |  |  ce:データチェックサム($100-$ce)
          |  |  |     |  32:データ
          |  |  |     ab:ヘッダチェックサム
          |  |  0600:アドレス
          |  01:ブロックサイズ
          01:ブロック番号B
(中略)
000008e0  ff ff ff ff ff ff ff ff  01 10 07 47 41 4c 41 58  |...........GALAX|
                                   ^  ^  ^  <---- ファイル名             
                                   |  |  |
                                   |  |  07:ブロック番号A
                                   |  10:テキスト
                                   01:開始マーク
000008f0  59 2e 53 01 02 06 00 99  ff ff 02 ff ff ff ff ff  |Y.S.............|
          -------> ^  ^  ^^^^^ ^   ^^^^^ ^
                   |  |  |     |   |     |
                   |  |  |     |   |     02:データチェックサム（$100-$ff-$ff)
                   |  |  |     |   ffff:データ（BASICソース終了マーク）
                   |  |  |     99:ヘッダチェックサム
                   |  |  0600:アドレス
                   |  02:ブロックサイズ
                   01:ブロック番号B
(中略)
00000930  ff ff ff ff ff ff ff ff  ff ff ff ff 01 00 07 47  |...............G|
                                               ^  ^  ^  <-
                                               |  |  |
                                               |  |  07:ブロック番号A
                                               |  00:最終ブロック
                                               01:開始マーク
00000940  41 4c 41 58 59 2e 53 01  01 06 00 aa ff 01        |ALAXY.S.......|
          -- ファイル名 -----> ^   ^  ^^^^^ ^  ^  ^
                               |   |  |     |  |  |
                               |   |  |     |  |  01:データチェックサム
                               |   |  |     |  ff:データ
                               |   |  |     aa:ヘッダチェックサム
                               |   |  0600:アドレス
                               |   01:ブロックサイズ
                               01:ブロック番号B
```

TinyGalaxy バイナリ

````
(前略)
00000030  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................| プリアンブル
00000040  ff 01 01 07 47 41 4c 41  58 59 2e 42 01 ff 10 00  |....GALAXY.B....|
             ^  ^  ^  <----- ファイル名 -----> ^  ^  ^^^^^
             |  |  |                           |  |  |
             |  |  |                           |  |  1000:アドレス
             |  |  |                           |  ff:ブロックサイズ
             |  |  |                           01:ブロック番号B
             |  |  07:ブロック番号A
             |  01:バイナリ
             01:開始マーク
00000050  b2 ce 01 7f a6 00 81 86  26 06 a7 20 86 20 a7 00  |........&.. . ..|
          ^  <---------- データ --------------------------
          |
          b2:ヘッダチェックサム
(中略)
00000150  8b 00 ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|
             ^
             |
             00:データチェックサム
(中略)
00000190  ff ff ff 01 00 07 47 41  4c 41 58 59 2e 42 01 01  |......GALAXY.B..|
                   ^  ^  ^  <----- ファイル名------> ^  ^
                   |  |  |                           |  |
                   |  |  |                           |  01:ブロックサイズ
                   |  |  |                           01:ブロック番号B
                   |  |  07:ブロック番号A
                   |  00:終了ブロック
                   01:開始マーク
000001a0  10 00 b1 ce 32 00                                 |....2.|
          ^^^^^ ^  ^  ^  ^
          |     |  |  |  |
          |     |  |  |  00:??
          |     |  |  32:データチェックサム
          |     |  ce:データ
          |     b1:ヘッダチェックサム
          1000:アドレス



